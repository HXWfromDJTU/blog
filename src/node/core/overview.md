## æ¦‚è¿°
æœ¬æ–‡ä¸»è¦ä¸ºNode.jså·¥ä½œåŸç†è§£æï¼Œä»æˆ‘ä»¬ç¼–å†™çš„`Application`åˆ°`Node`,å†åˆ°`v8ç¼–è¯‘è§£æ`ï¼Œä¹Ÿä¼šèŠèŠå¤§å®¶æ¯”è¾ƒå…³å¿ƒçš„`Libuv`å’Œ`EventLoop`çš„6é˜¶æ®µï¼Œæ‰€ä»¥æŠŠä¹‹å‰æ‹†åˆ†å¼€çš„å†…å®¹ï¼Œæ±‡æ€»åˆ°ä¸€èµ·ä¾¿äºå¤§å®¶æ•´ä½“ç†è§£ã€‚

å…¶å®æ¯ä¸€ä¸ªç‚¹éƒ½å¯ä»¥è®²ä¸Šä¸€å¤©ï¼Œæœ¬æ–‡ä¸»è¦ä¸ºå¤§å®¶ç†æ¸…æ¥šè¿™å‡ ä¸ªè¿‡ç¨‹é—´çš„å…³ç³»ï¼Œå¾ˆå¤šç»†èŠ‚åˆ™ä¸å¤šèµ˜è¿°ã€‚


## Node.js Framework
![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/node_framework.png)  

##### ç¬¬ä¸€å±‚(Javascriptä¾èµ–åŒ…)
* Standard Libary æ˜¯æˆ‘ä»¬æ—¥å¸¸é¡¹ç›®å¸¸ç”¨çš„`HTTP` `Buffer`ç­‰æ¨¡å—  

##### ç¬¬äºŒå±‚(æ¡¥é˜¶å±‚)
* Node Binding æ˜¯æ²Ÿé€šC++å’ŒJavascriptçš„æ¡¥æ¢,å°è£…äº†åº•å±‚Cä¸C++æ¨¡å—åŒ…ï¼Œæš´éœ²å‡ºJavaScriptæ¥å£ç»™ä¸Šå±‚è°ƒç”¨  

##### ç¬¬ä¸‰å±‚ (C/C++ä¾èµ–åŒ…)
è¿™ä¸€å±‚æ˜¯æ”¯æ’‘ Node.js è¿è¡Œçš„å…³é”®ï¼Œç”± C/C++ å®ç°
* V8ä¸å¿…å¤šè¯´ç›¸å½“äºNodejsçš„å¼•æ“(V8ç›¸å…³çš„ç¬”è®°ğŸ“’ï¼Œ[ä¼ é€é—¨](/node/v8/v8.md))

* libuv å¡«å¹³äº†å¤šä¸ªå¹³å°çš„å¯¹å¼‚æ­¥I/Oçš„ä¸åŒå®ç°ï¼Œåœ¨Winå¹³å°ä¸Šåˆ™æ˜¯ç›´æ¥ä½¿ç”¨IOCPä»£æ›¿è½¬è®©éƒ¨åˆ†çš„åŠŸèƒ½ã€‚ (libuvçš„ç¬”è®°ğŸ“’ï¼Œ[ä¼ é€é—¨](/node/core/libuv/libUV.md))

* `C-ares` æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„ä¸€ä¸ªå¼‚æ­¥`DNS`æŸ¥æ‰¾çš„ä¸€ä¸ªåº•å±‚åº“ï¼Œè‘—åçš„`Node.js` `curl` `gevent`éƒ½ä½¿ç”¨äº†`C-ares`ä½œä¸ºåº•å±‚

* `http_parser`ã€`OpenSSL`ã€`zlib`ç­‰æ¨¡å—å®ç°äº†ä¸€äº›å’Œç½‘ç»œè¯·æ±‚å°è£…æœ‰å…³çš„ä¸œè¥¿ï¼Œæ¯”å¦‚è¯´`httpè§£æ`ã€`SSL`å’Œ`æ•°æ®å‹ç¼©`ã€‚  

* å¯ä»¥åœ¨nodeæºç çš„`/deps`ç›®å½•ä¸­æ‰¾åˆ°éƒ½æœ‰å“ªäº›C/C++ä¾èµ–![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/node_source.png)

##### ç¬¬å››å±‚ æ“ä½œç³»ç»Ÿ
ç¬¬ä¸‰å±‚çš„å†…å®¹éƒ½æ˜¯C/C++ç¼–å†™çš„ä¾èµ–ï¼Œåœ¨å„æ“ä½œç³»ç»Ÿå¹³å°ä¸‹ï¼Œéƒ½ä¼šç›´æ¥è°ƒç”¨ç³»ç»Ÿ`Api`å»å®Œæˆå¯¹åº”çš„ä»»åŠ¡ã€‚
___

äº†è§£äº†Node.jsçš„æ•´ä½“æ¶æ„åï¼Œä¸éš¾å‘ç°æ¶æ„ä¸­`ç¬¬ä¸‰å±‚`ä¸­çš„å„ç§`C/C++`ä¾èµ–æ­£æ˜¯`Node.js`å®ç°å®ƒçš„å•çº¿ç¨‹é»‘é­”æ³•çš„å…³é”®æ‰€åœ¨ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±è¯¦ç»†çœ‹çœ‹è¿™äº›ä¾èµ–ä»¬ã€‚

## V8
#### ç¼–è¯‘
|å¼•æ“|å¤„ç†æµç¨‹|ä¼˜ç¼ºç‚¹|
|---|---|---|
| æ—§ç‰ˆv8 | JavaScript ä»£ç  ---> AST ---> V8 ç›´æ¥æ‰§è¡Œè¿™äº›æœªä¼˜åŒ–è¿‡çš„æœºå™¨ç  ---> é«˜é¢‘ç‡è¿‡é«˜çš„ä»£ç ä¼˜åŒ–ä¸ºæœºå™¨ç  | â‘ æƒ°æ€§ç¼–è¯‘ï¼Œç¼–è¯‘æ—¶é—´è¿‡ä¹…ï¼Œå½±å“ä»£ç å¯åŠ¨é€Ÿåº¦   â‘¡ç¼–è¯‘å‡ºçš„æœºå™¨ç é€šå¸¸ä¸ºæºJSä»£ç å¤§å°çš„å‡ åƒå€    â‘¢ä½¿ç”¨å†…å­˜ã€ç¡¬ç›˜è¿›è¡Œç¼“å­˜åœ¨ç§»åŠ¨ç«¯å†…å­˜å ç”¨é—®é¢˜æ˜æ˜¾ |
| æ–°ç‰ˆv8 | æºä»£ç  ---> AST ---> å­—èŠ‚ç  ---> è§£é‡Šå™¨æ‰§è¡Œå­—èŠ‚ç  | â‘ å­—èŠ‚ç å ç”¨ç©ºé—´è¿œå°äºæœºå™¨ç ï¼Œæœ‰æ•ˆå‡å°‘å†…å­˜å ç”¨ â‘¡å°†å­—èŠ‚ç è½¬æ¢ä¸ºä¸åŒæ¶æ„çš„äºŒè¿›åˆ¶ä»£ç çš„å·¥ä½œé‡ä¹Ÿä¼šå¤§å¤§é™ä½ â‘¢å¼•å…¥å­—èŠ‚ç ï¼Œä½¿å¾—V8 ç§»æ¤åˆ°ä¸åŒçš„ CPU æ¶æ„å¹³å°æ›´åŠ å®¹æ˜“ |

* ##### å­—èŠ‚ç 
   â‘  è§£é‡Šå™¨å¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œå­—èŠ‚ç ã€‚    
   â‘¡ å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´ç ï¼Œå ç”¨å†…å­˜ç›¸è¾ƒæœºå™¨ç å°ï¼Œä¸å—cpuå‹å·å½±å“ã€‚
* ##### æœºå™¨ç 
   â‘  æœºå™¨ç å¯ä»¥è¢«cpuç›´æ¥è§£è¯»ï¼Œè¿è¡Œé€Ÿåº¦å¿«ã€‚
   â‘¡ ä½†æ˜¯ä¸åŒcpuæœ‰ä¸åŒä½“ç³»æ¶æ„ï¼Œä¹Ÿå¯¹åº”ä¸åŒæœºå™¨ç ã€‚å ç”¨å†…å­˜ä¹Ÿè¾ƒå¤§ã€‚

#### æ§åˆ¶ä¸æ‰§è¡Œ
v8æ— è®ºæ˜¯åœ¨æµè§ˆå™¨ç«¯è¿˜æ˜¯Node.jsç¯å¢ƒä¸‹éƒ½ä¼šå¯ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹`(æµè§ˆå™¨ä¸­ç§°ä¸ºä¸ºUIçº¿ç¨‹)`ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”¨äºå­˜æ”¾å³å°†è¢«æ‰§è¡Œçš„å®ä»»åŠ¡ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¸»çº¿ç¨‹ä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚    

##### å®ä»»åŠ¡
æ¯ä¸ªå®ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼ŒV8éƒ½ä¼šé‡æ–°åˆ›å»ºæ ˆï¼Œæ‰€æœ‰çš„å‡½æ•°éƒ½ä¼šè¢«å‹å…¥æ ˆä¸­ç„¶åé€ä¸ªæ‰§è¡Œï¼Œç›´åˆ°æ•´ä¸ªæ ˆéƒ½è¢«æ¸…ç©ºã€‚

##### å¾®ä»»åŠ¡
å¾®ä»»åŠ¡çš„å‡ºç°ï¼Œæ˜¯ä¸ºäº†åœ¨å¤šä¸ªåœ¨ç²’åº¦è¾ƒå¤§çš„å®ä»»åŠ¡ä¹‹é—´ç©¿æ’æ›´å¤šçš„æ“ä½œã€‚å¾®ä»»åŠ¡å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªéœ€è¦å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œæ‰§è¡Œçš„æ—¶æœºåœ¨å½“å‰çš„å®ä»»åŠ¡çš„ä¸»ä»£ç å¿«æ‰§è¡Œå®Œä¹‹åï¼Œåœ¨æ•´ä¸ªå®ä»»åŠ¡æ‰§è¡Œç»“æŸä¹‹å‰ã€‚

é€šä¿—åœ°ç†è§£ï¼ŒV8 ä¼šä¸ºæ¯ä¸ªå®ä»»åŠ¡ç»´æŠ¤ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”Ÿæˆä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè¯¥å¾®ä»»åŠ¡ä¼šè¢« V8 è‡ªåŠ¨æ·»åŠ è¿›å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰æ•´æ®µä»£ç å¿«è¦æ‰§è¡Œç»“æŸæ—¶ï¼Œè¯¥ç¯å¢ƒå¯¹è±¡ä¹Ÿéšä¹‹è¢«é”€æ¯ï¼Œä½†æ˜¯åœ¨é”€æ¯ä¹‹å‰ï¼ŒV8 ä¼šå…ˆå¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡ã€‚

![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/micro_task_know.png)

## libuv
`libuv` æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ï¼Œäº‹ä»¶é©±åŠ¨çš„`I/O`åº“ï¼Œè¿™ä¸ªåº“è´Ÿè´£å„ç§å›è°ƒå‡½æ•°çš„æ‰§è¡Œç†Ÿé¡ºåºã€‚ç«¥é‹ä»¬ç†ŸçŸ¥çš„`EventLoop`ä¸`Thread Pool`éƒ½ç”±`Libuv`å®ç°ã€‚

![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/node_libuv_dir.png)


åœ¨ `ã€Šå›¾è§£ Google V8ã€‹`ä¸­æœ‰ä¸€æ®µæè¿°ååˆ†ç»å…¸ï¼Œè¿™é‡Œç›´æ¥å¼•ç”¨ä¸€ä¸‹
> Node æ˜¯ V8 çš„å®¿ä¸»ï¼Œå®ƒä¼šç»™ V8 æä¾›äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚åœ¨ Node ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ç”± libuv æä¾›çš„ï¼Œlibuv å·¥ä½œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå®ƒä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œäº‹ä»¶ã€‚ 
åŒæ ·ï¼Œå¯¹äºä¸€äº›ä¸»çº¿ç¨‹ä¸Šä¸é€‚åˆå¤„ç†çš„äº‹ä»¶ï¼Œæ¯”å¦‚æ¶ˆè€—æ—¶é—´è¿‡ä¹…çš„ç½‘ç»œèµ„æºä¸‹è½½ã€æ–‡ä»¶è¯»å†™ã€è®¾å¤‡è®¿é—®ç­‰ï¼ŒNode ä¼šæä¾›å¾ˆå¤šçº¿ç¨‹æ¥å¤„ç†è¿™äº›äº‹ä»¶ï¼Œæˆ‘ä»¬æŠŠè¿™äº›çº¿ç¨‹ç§°ä¸ºçº¿ç¨‹æ± ã€‚  

![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/node_libuv.png)

æ‹¿æ–‡ä»¶è¯»å†™æ“ä½œæ¥è¯´ï¼Œå¦‚ä¸Šå›¾libuvå°±ä¼šå¯ç”¨`Thread Pool`ä¸­çš„æ–‡ä»¶è¯»å†™çº¿ç¨‹è¿›è¡Œæ–‡ä»¶è¯»å†™ã€‚è¯»å†™å®Œæ¯•åï¼Œè¯¥çº¿ç¨‹ä¼šå°†è¯»å†™çš„ç»“æœåŒ…è£…æˆå‡½æ•°çš„å½¢å¼ï¼Œå¡å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œã€‚


#### å…³äºçº¿ç¨‹æ± 
* æ¯ä¸€ä¸ª`node`è¿›ç¨‹ä¸­ï¼Œ`libuv`éƒ½ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹æ± ã€‚
* å› ä¸ºåŒå¤„äºä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å…±äº«è¿›ç¨‹ä¸­çš„ä¸Šçº¿æ–‡ã€‚
* åªæœ‰`æ–‡ä»¶è¯»å–`ã€`è·¨åŸŸè®¿é—®`ã€`dnsæŸ¥è¯¢`æ˜¯ä½¿ç”¨çº¿ç¨‹æ± æ¥å¤„ç†çš„ï¼Œé»˜è®¤ä½¿ç”¨4ä¸ªçº¿ç¨‹ã€‚
ï¼ˆç¿»è¯‘è‡ª[æ–‡ç« ](https://link.juejin.im/?target=http%3A%2F%2Fvoidcanvas.com%2Fnodejs-event-loop%2F),é…å›¾æ¥è‡ªlibuvå›¢é˜Ÿçš„æ¼”è®²ï¼‰

  ![](/blog_assets/libuv_thread_pool_only_for_file_io.png)

## EventLoop in Node.js
![](/blog_assets/libuv_loop_official.png)
* äº‹ä»¶å¾ªç¯çš„èŒè´£ï¼Œå°±æ˜¯ä¸æ–­å¾—ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼Œç„¶åå°†è¿™ä¸ªäº‹ä»¶çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œä»¥å®ƒä»¬è®¢é˜…è¿™ä¸ªäº‹ä»¶çš„æ—¶é—´é¡ºåºï¼Œä¾æ¬¡æ‰§è¡Œã€‚å½“è¿™ä¸ªäº‹ä»¶çš„æ‰€æœ‰å¤„ç†å™¨éƒ½è¢«æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šå¼€å§‹ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶çš„è§¦å‘ï¼Œä¸æ–­å¾€å¤ã€‚

* å³å¦‚æœæŸä¸ªäº‹ä»¶ç»‘å®šäº†ä¸¤ä¸ªå¤„ç†å™¨ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå¤„ç†å™¨ä¼šåœ¨ç¬¬ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œå®Œæ¯•åï¼Œæ‰å¼€å§‹æ‰§è¡Œã€‚

é¦–å…ˆåˆ¤æ–­å½“å‰`loop`çš„çŠ¶æ€ï¼Œåªæœ‰å¤„äºæ¿€æ´»çŠ¶æ€æ‰ä¼šå¼€å§‹æ‰§è¡Œå‘¨æœŸï¼Œè‹¥å¤„äºéæ¿€æ´»çŠ¶æ€ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸éœ€è¦åšã€‚

#### ä»æºç ä¸­çœ‹ EventLoop
```c++
int uv_run(uv_loop_t* loop, uv_run_mode mode) {
  int timeout;
  int r;
  int ran_pending;

  /*
  ä»uv__loop_aliveä¸­æˆ‘ä»¬çŸ¥é“event loopç»§ç»­çš„æ¡ä»¶æ˜¯ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ï¼š
  1ï¼Œæœ‰æ´»è·ƒçš„handlesï¼ˆlibuvå®šä¹‰handleå°±æ˜¯ä¸€äº›long-lived objectsï¼Œä¾‹å¦‚tcp serverè¿™æ ·ï¼‰
  2ï¼Œæœ‰æ´»è·ƒçš„request
  3ï¼Œloopä¸­çš„closing_handles
  */
  r = uv__loop_alive(loop);

  //  å‡è‹¥ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™æ›´æ–° loop é‡Œçš„update_times
  if (!r)
    uv__update_time(loop);  // æ›´æ–° loop å®ä½“çš„ timeå±æ€§ä¸ºå½“å‰æ—¶é—´

  while (r != 0 && loop->stop_flag == 0) {
    uv__update_time(loop); // æ›´æ–°æ—¶é—´å˜é‡ï¼Œè¿™ä¸ªå˜é‡åœ¨uv__run_timersä¸­ä¼šç”¨åˆ°
    uv__run_timers(loop); // æ‰§è¡Œtimersé˜¶æ®µ
    ran_pending = uv__run_pending(loop);//ä»libuvçš„æ–‡æ¡£ä¸­å¯çŸ¥ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯I/O callbacké˜¶æ®µ,ran_pendingæŒ‡ç¤ºé˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
    uv__run_idle(loop);//idleé˜¶æ®µ
    uv__run_prepare(loop);//prepareé˜¶æ®µ

    timeout = 0;

    /**
    è®¾ç½®pollé˜¶æ®µçš„è¶…æ—¶æ—¶é—´ï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹è¶…æ—¶ä¼šè¢«è®¾ä¸º0ï¼Œè¿™æ„å‘³ç€æ­¤æ—¶pollé˜¶æ®µä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨ä¸‹é¢çš„pollé˜¶æ®µæˆ‘ä»¬è¿˜ä¼šè¯¦ç»†è®¨è®ºè¿™ä¸ª
    1ï¼Œstop_flagä¸ä¸º0
    2ï¼Œæ²¡æœ‰æ´»è·ƒçš„handleså’Œrequest
    3ï¼Œidleã€I/O callbackã€closeé˜¶æ®µçš„handleé˜Ÿåˆ—ä¸ä¸ºç©º
    å¦åˆ™ï¼Œè®¾ä¸ºtimeré˜¶æ®µçš„callbacké˜Ÿåˆ—ä¸­ï¼Œè·ç¦»å½“å‰æ—¶é—´æœ€è¿‘çš„é‚£ä¸ª
    **/    
    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT){
      timeout = uv_backend_timeout(loop); // è¿™ä¸ªå‡½æ•°è°ƒç”¨è®¡ç®—é™¤äº†ï¼ŒI/Oå°†ä¼šé˜»å¡å¤šå°‘æ—¶é—´

      uv__io_poll(loop, timeout);//pollé˜¶æ®µ
      uv__run_check(loop);//checké˜¶æ®µ
      uv__run_closing_handles(loop);//closeé˜¶æ®µ
      //å¦‚æœmode == UV_RUN_ONCEï¼ˆæ„å‘³ç€æµç¨‹ç»§ç»­å‘å‰ï¼‰æ—¶ï¼Œåœ¨æ‰€æœ‰é˜¶æ®µç»“æŸåè¿˜ä¼šæ£€æŸ¥ä¸€æ¬¡timersï¼Œè¿™ä¸ªçš„é€»è¾‘çš„åŸå› ä¸å¤ªæ˜ç¡®
    
      if (mode == UV_RUN_ONCE) {
        uv__update_time(loop);
        uv__run_timers(loop);
      }

      r = uv__loop_alive(loop);
      if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)
       break;
    }

    if (loop->stop_flag != 0) {
        loop->stop_flag = 0;
    }

    return r;
}
```
#### timers
* ä½¿ç”¨ä¸€ä¸ª`for`å¾ªç¯æ‰§è¡Œæ‰€æœ‰çš„ `setTimeout` , `setInterval`çš„å›è°ƒã€‚æºç åœ¨æ­¤ã€‚[ä¼ é€é—¨>>](https://github.com/libuv/libuv/blob/9ed3ed5fcb3f19eccd3d29848ae2ff0cfd577de9/src/unix/timer.c#L150)

* å›è°ƒéƒ½ä¼šè¢«å­˜å…¥ä¸€ä¸ªæœ€å°å †(min heap)ä¸­ï¼Œè¿™æ ·å¼•æ“åªéœ€è¦æ¯æ¬¡åˆ¤æ–­å¤´å…ƒç´ ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶å°±æ‹¿å‡ºæ¥æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªä¸ç¬¦åˆæ¡ä»¶æˆ–è€…é˜Ÿåˆ—ç©ºäº†æ‰ç»“æŸ`timers phase`
![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/min_set.png)
>æœ€å°å †ï¼Œæ˜¯ä¸€ç§ç»è¿‡æ’åºçš„å®Œå…¨äºŒå‰æ ‘ï¼Œå…¶ä¸­ä»»ä¸€éç»ˆç«¯èŠ‚ç‚¹çš„æ•°æ®å€¼å‡ä¸å¤§äºå…¶å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹çš„å€¼ã€‚è¿™é‡Œä¸ä½¿ç”¨é˜Ÿåˆ—æ¥å®ç°ï¼Œæ˜¯å› ä¸ºtimeoutçš„callbackæ˜¯æŒ‰ç…§è®¾ç½®çš„æ—¶é—´é•¿çŸ­æ¥æ’åˆ—å…ˆåè€Œè°ƒç”¨çš„ï¼Œå¹¶ä¸æ˜¯å…ˆè¿›å…ˆå‡ºçš„é€»è¾‘é˜Ÿåˆ—ã€‚

* ä¸€ä¸ª`Node.js`çš„timerä¸`libuv`çš„timeré˜¶æ®µå¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„,è‹¥å¤šä¸ª`Node.js`ä¸­çš„timeréƒ½åˆ°æœŸäº†ï¼Œåˆ™ä¼šåœ¨ä¸€ä¸ª`libuv`çš„timeré˜¶æ®µæ‰€å¤„ç†ã€‚

* æ­¤å¤–ï¼Œä¸ºäº†é˜²æ­¢æŸä¸ªé˜¶æ®µä»»åŠ¡å¤ªå¤šï¼Œè€Œä½¿å¾—åç»­çš„é˜¶æ®µå‡ºç°é¥¥é¥¿çš„ç°è±¡ï¼Œä¼šç»™æ¯ä¸ªé˜¶æ®µè®¾ç½®ä¸€ä¸ªæœ€å¤§çš„å›è°ƒæ•°é‡ï¼Œæ‰§è¡Œè¶…è¿‡è¿™ä¸ªä¸Šé™çš„å›è°ƒæ•°ç›®ä¹‹åï¼Œä¼šè‡ªåŠ¨è·³å‡ºè¿™ä¸ªé˜¶æ®µ,è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

#### pending callbacks (I/O Callback)
* è¿™ä¸€é˜¶æ®µä¼šæ‰§è¡Œ `fs.read`ï¼Œ`socket`ç­‰`I/O`æ“ä½œçš„å›è°ƒå‡½æ•°   
* åŒæ—¶ä¹ŸåŒ…æ‹¬å„ç§`error`çš„å›è°ƒ    
* å¤„ç†ä¸Šä¸€è½®æ®‹ç•™çš„`I/O`æ“ä½œ  
* ç†è®ºä¸Šæ¥è¯´ï¼Œ`poll`é˜¶æ®µä¼šè¢«`timers`é˜¶æ®µä»£ç çš„æ‰§è¡Œæ‰€é˜»å¡ã€‚   

#### idle ä¸ prepare 
åªåœ¨å†…éƒ¨æ‰§è¡Œ

#### poll 
pollæ˜¯æ•´ä¸ªæ¶ˆæ¯å¾ªç¯ä¸­æœ€é‡è¦çš„ä¸€ä¸ªé˜¶æ®µï¼Œä½œç”¨æ˜¯ç­‰å¾…å¼‚æ­¥è¯·æ±‚å’Œæ•°æ®ï¼Œæ–‡æ¡£åŸè¯æ˜¯
>Acceptc new incomming connection( new socket establishment ect) and dat (file read etc)

ä»–æ”¯æ’‘äº†æ•´ä¸ªæ¶ˆæ¯å¾ªç¯æœºåˆ¶  

| é˜¶æ®µ | |
|-- | -- |
| poll phase æ‰§è¡Œ | `poll phase`é¦–å…ˆä¼šæ‰§è¡Œ `watch_queue` é˜Ÿåˆ—ä¸­çš„`I/O`  ä¸€æ—¦`watch_queue`ä¸­çš„é˜Ÿåˆ—ç©ºï¼Œåˆ™æ•´ä¸ªæ¶ˆæ¯å¾ªç¯åˆ™ä¼šè¿›å…¥`sleep`(ä¸åŒå¹³å°å®ç°çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•ä¸ä¸€æ ·)ï¼Œä»è€Œç­‰å¾…è¢«å†…æ ¸æ—¶é—´å”¤é†’ã€‚|
| poll phaseç­‰å¾… | ç®€å•æ¥è¯´é¦–å…ˆä¼šåˆ¤æ–­åé¢çš„ `check phase` ä»¥åŠ `close phase`æ˜¯å¦è¿˜æœ‰ç­‰å¾…å¤„ç†çš„å›è°ƒã€‚  å¦‚æœæœ‰ï¼Œåˆ™ä¸ç­‰å¾…ï¼Œç›´æ¥è¿›å…¥`check phase`ã€‚|
| poll phase è¶…æ—¶ | å¦‚æœæ²¡æœ‰å…¶ä»–å›è°ƒç­‰å¾…æ‰§è¡Œï¼Œä»–ä¼šç»™`epoll` æ–¹æ³•è®¾ç½®ä¸€ä¸ª`timeout`ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¿™æ®µæ—¶é—´çš„é•¿åº¦ä¸€èˆ¬æ˜¯ `timer phase` ä¸­æœ€è¿‘è¦æ‰§è¡Œçš„å›è°ƒå¯åŠ¨æ—¶é—´ï¼Œåˆ°ç°åœ¨çš„å·®å€¼ã€‚ |

å…·ä½“`epoll`çš„å®ç°è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒå¦ä¸€ç¯‡ç¬”è®°[Socket ç¼–ç¨‹ - I/O å¤šè·¯å¤ç”¨](https://github.com/HXWfromDJTU/blog/issues/13)


#### check phase
è¿™ä¸ªé˜¶æ®µåªå¤„ç†`setImmediate`çš„å›è°ƒå‡½æ•°  

å› ä¸º`poll phase`é˜¶æ®µå¯èƒ½è®¾ç½®ä¸€äº›å›è°ƒï¼Œå¸Œæœ›åœ¨ `poll  phase`åè¿è¡Œï¼Œæ‰€ä»¥åœ¨`poll phase`åé¢å¢åŠ äº†è¿™ä¸ª`check phase`

#### close callback
ä¸“é—¨å¤„ç†ä¸€äº› closeç±»å‹çš„å›è°ƒï¼Œæ¯”å¦‚`socket.on('close',....)`ï¼Œç”¨äºæ¸…ç†èµ„æºã€‚


### libuvå°ç»“
* `Node.js`ä¸­`v8`å€ŸåŠ©`libuv`æ¥å®ç°å¼‚æ­¥å·¥ä½œçš„è°ƒåº¦ï¼Œä½¿å¾—ä¸»çº¿ç¨‹åˆ™ä¸é˜»å¡
* `libuv`ä¸­çš„`poll`é˜¶æ®µï¼Œä¸»è¦å°è£…äº†å„å¹³å°çš„å¤šè·¯å¤ç”¨ç­–ç•¥`epoll`/`kqueue`/`event ports`ç­‰ï¼Œå¯¹`I/O`äº‹ä»¶çš„ç­‰å¾…å’Œåˆ°è¾¾æ¥é©±åŠ¨æ•´ä¸ªæ¶ˆæ¯å¾ªç¯ã€‚
* ä½¿ç”¨`Node.js`æ—¶ï¼Œä½¿ç”¨è€…æ˜¯å•çº¿ç¨‹çš„æ¦‚å¿µã€‚ä½†äº†è§£å…¶`çº¿ç¨‹æ± `è§„åˆ™ä¹‹åï¼Œæˆ‘ä»¬ä»å¯`éšå¼`åœ°å»ä½¿ç”¨`å¤šçº¿ç¨‹`çš„ç‰¹æ€§ï¼Œåªæ˜¯çº¿ç¨‹çš„è°ƒåº¦å®Œå…¨äº¤ç»™äº†`Node.js`çš„å†…æ ¸ã€‚

![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/libuv_deep_in.png)


## å‚è€ƒèµ„æ–™
[1] [NodeConf EU | A deep dive into libuv - Saul Ibarra Coretge](https://www.youtube.com/watch?v=sGTRmPiXD4Y)
[2] [libuv & Node.js EventLoop](https://mlib.wang/2020/03/01/v8-libuv-timer-event-loop/)
[3] [The Node.js Event Loop: Not So Single Threaded](https://www.youtube.com/watch?v=zphcsoSJMvM)
[4] [ã€Šå›¾è§£ Google V8ã€‹](https://time.geekbang.org/column/article/224206)
[5] [Introduction to libuv: What's a Unicorn Velociraptor? - Colin Ihrig, Joyent](https://www.youtube.com/watch?v=_c51fcXRLGw)


<!-- ## å…¶ä»–æ¦‚å¿µç†è§£
## ä¸¾ä¾‹è¯´æ˜
#### å¯ä»¥åˆ›å»ºå¼‚æ­¥æ“ä½œçš„åŠ¨ä½œ

```js
setTimeout(() => {console.log(1)})

setImmediate(() => {console.log(2)})

process.nextTick(() => {console.log(3)})

Promise.resolve().then(() => {console.log(4)})

console.log(5)
```

```js
5
3
4
1
2
```

### setImmediate ä¸ setTimeout
å…ˆæ¥çœ‹ä¸€ä¸ªä»£ç çš„æ‰§è¡Œæƒ…å†µ
```js
setTimeout(function(){
   console.log('1');
},0)
setImmediate(function(){
  console.log('2')
})
```
![](https://raw.githubusercontent.com/HXWfromDJTU/blog/master/blog_assets/setImmediate_timeout.png)  

##### ç»“åˆä¸Šé¢çš„ eventloopæ¥è¯´
1ï¸âƒ£ `setTimeout`èƒ½å¤Ÿæ¥å—çš„æœ€å°æ—¶é™æ˜¯`4æ¯«ç§’`(`setInterval`æ˜¯10æ¯«ç§’)ï¼Œæ‰€ä»¥è®¡ç®—æœºæ¥å—åˆ°çš„æ•°å­—æ˜¯4æ¯«ç§’  
2ï¸âƒ£  å½“ä»£ç æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆè¿›å…¥eventloopçš„timmeré˜¶æ®µï¼Œè‹¥æœºå™¨æ‰§è¡Œå¾ˆæ…¢ï¼Œè¿›å…¥eventloopçš„æ—¶å€™å·²ç»è¶…è¿‡äº†4æ¯«ç§’ï¼Œé‚£ä¹ˆsetTimeoutçš„callbackå°±ä¼šé©¬ä¸Šè¢«æ‰§è¡Œã€‚è€Œæœºå™¨æ€§èƒ½æ¯”è¾ƒå¥½ï¼Œ4msè¿˜æ²¡æœ‰åˆ°ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œåˆ°pollé˜¶æ®µçš„åˆ¤æ–­ï¼Œå‘ç°`check phase`ä¸­æœ‰è®¾å®šçš„`setimmediate`çš„å›è°ƒï¼Œåˆ™ä¼šç«‹å³æ‰§è¡Œã€‚  
3ï¸âƒ£ æ‰€ä»¥è¯´`setImmediate`ä¸`setTimout`çš„æ‰§è¡Œå’Œä»£ç æ‰§è¡Œçš„ç¯å¢ƒæœ‰å¾ˆå¤§çš„å…³ç³»ã€‚  


### process.nextTick
process.nextTick å’Œ Vueçš„`this.$nextTick` æœºåˆ¶æ˜¯ç±»ä¼¼çš„ã€‚
1ï¸âƒ£ æˆ‘ä»¬çŸ¥é“ this.$nextTickæ˜¯å±äºå¾®ä»»åŠ¡ï¼Œè€Œå¾®ä»»åŠ¡ä¼šåœ¨æ¯ä¸€ä¸ªå®ä»»åŠ¡ç»“æŸçš„æ—¶å€™éƒ½éœ€è¦æ¸…ç©ºæ‰€æœ‰çš„å¾®ä»»åŠ¡  
2ï¸âƒ£ process.nextTickä¹Ÿæ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè€ŒeventLoopä¸­çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½å¯ä»¥çœ‹åšä¸€ä¸ªå®ä»»ï¼Œåœ¨æ¯ä¸€ä¸ªé˜¶æ®µäº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼Œå½“ç„¶å°±è¦åœ¨ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œä¹‹å‰æ‰§è¡Œæ¸…ç©ºæ‰§è¡Œå®Œæ¯•ã€‚ 
```js
setTimeout(() => {
    console.log('timeout0');
    // å¾®ä»»åŠ¡
    process.nextTick(() => {
        console.log('nextTick1');
        // å¾®ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡
        process.nextTick(() => {
            console.log('nextTick2');
        });
    });
    process.nextTick(() => {
        console.log('nextTick3');
    });
    console.log('sync');
    // æ–°ä¸€å±‚å®ä»»åŠ¡
    setTimeout(() => {
        console.log('timeout2');
    }, 0);
}, 0);
```
___
nodeçš„å‡ ä¸ªæ ¸å¿ƒä¾èµ–æ¨¡å—

* I/Oè¯·æ±‚  æ ¹æ®å¹³å°ä¸ä¸€æ ·ï¼Œä½¿ç”¨ä¸åŒçš„è§£å†³æ–¹æ¡ˆã€‚
* Fileè¯·æ±‚ æ‰€æœ‰å¹³å°åˆ™ä½¿ç”¨çº¿ç¨‹æ± çš„è§£å†³æ–¹æ¡ˆ -->
