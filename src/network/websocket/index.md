# websocket é¡¹ç›®å®æˆ˜ - è¿æ¥ã€é‰´æƒã€å¿ƒè·³ä¸æ•°æ®å®‰å…¨

## å‰è¨€
æœ€è¿‘åœ¨åšä¸€ä¸ªè¡Œæƒ…æ¨¡å—ï¼Œåç«¯åŒå­¦å»ºè®®ç›´æ¥ä¸Š`websocket`ç»ƒç»ƒæ‰‹ï¼Œä¹Ÿç¬¦åˆä¸šç•ŒåŸºæ“ã€‚è¿™é‡Œå°±è®°å½•ä¸€äº›å¼€å‘ä¸­é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼ŒèŠä¸€èŠè§£å†³æ–¹æ¡ˆã€‚è¿™é‡Œä¸å†å»ä¸€ç‚¹ç‚¹é™ˆåˆ—`websocket`çš„çŸ¥è¯†ç‚¹ï¼Œä¸»è¦ä¼šå›´ç»•é¡¹ç›®çš„ç—›ç‚¹æ¥è¯´ã€‚

ps: é£Ÿç”¨æœ¬æ–‡æ—¶ï¼Œå»ºè®®å‡ºå‘ç‚¹éœ€è¦å‘ä¸‹æ²‰ï¼Œä»`ä¼ è¾“å±‚`å¼€å§‹æ€è€ƒï¼Œåšç±»ä¼¼`http`(åº”ç”¨å±‚)éœ€è¦å®Œæˆçš„äº‹ã€‚


## é€‰å‹

### ç¬¬ä¸‰æ–¹lib
| ç«¯ | è¯­è¨€ | æ¡†æ¶(lib) | ç¯å¢ƒ |
| --- | --- | --- | --- |
| åç«¯ | Go | gin |  CentOS |
| å‰ç«¯ | TS | axios | æµè§ˆå™¨|

é¡¹ç›®å½“å‰çš„å‰åç«¯é€‰å‹å¦‚ä¸Šè¡¨ï¼Œå› ä¸º`websocket`æ˜¯ä¸€ä¸ªåŸºäº`tcp`çš„åº”ç”¨å±‚åè®®ï¼Œå°±åƒ`http`å®¢æˆ·ç«¯æœåŠ¡å™¨çº¦å®šçš„`è¯·æ±‚å¤´`ã€`å“åº”å¤´`ã€`cookie`ç­‰çº¦å®šï¼Œå’Œ`ä¸€å‘ä¸€æ”¶`äº¤äº’å½¢å¼ï¼Œ`websocket`åœ¨ä½¿ç”¨çš„æ—¶å€™ç›¸å½“äºå°†è¿™éƒ¨åˆ†çº¦å®šçš„æƒåˆ©ï¼Œé‡æ–°äº¤ç»™äº†æˆ‘ä»¬å¼€å‘è€…ã€‚

é‚£ä¹ˆå¦‚æœè€ƒè™‘ä½¿ç”¨`websockt`çš„`lib`è¿›è¡Œé¡¹ç›®æ„å»ºæ—¶ï¼Œåˆ™éœ€è¦è€ƒå¯Ÿè¯¥æ–¹æ¡ˆåœ¨ä¸¤ç«¯æ˜¯å¦éƒ½æœ‰å®ç°çš„æ–¹æ¡ˆï¼Œ


| æ¡†æ¶(lib) | æœåŠ¡ç«¯æ”¯æŒ(Go) | æµè§ˆå™¨æ”¯æŒ | å‘¨ä¸‹è½½é‡ | åŒ…å¤§å° | å…¶ä»– |
| --- | --- | --- | --- | --- | --- |
| socket.io | âœ… [go-socket.io](https://github.com/googollee/go-socket.io) | âœ… | 3,309,990  | 55.9 kB | æ”¯æŒç­–ç•¥é€€åŒ–åˆ°Polling |
| ws | âœ… | âŒ | 25,770,149 | 110 kB |

### åŸç”Ÿå°è£…
å› ä¸ºè¿™æ¬¡çš„æ¨¡å—æ˜¯`websocket`å°é²œï¼Œæ‰€ä»¥æ²¡æœ‰è€ƒè™‘å¤ªå¤šï¼Œæœ€åå†³å®š`å‰ç«¯`è¿™è¾¹ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ”¯æŒ`Websocket`å¯¹è±¡ï¼Œæ ¹æ®è¿™æ¬¡çš„è¦æ±‚è¿›è¡Œç®€ç­”çš„å°è£…ï¼Œå…ˆè¶Ÿè¶Ÿå‘ï¼Œæ­£å¼ä¸Šçº¿åå†æ…¢æ…¢è€ƒå¯Ÿæ¡†æ¶ã€‚

å¼€å·¥å‰ï¼Œå‡ ä¸ªå‰ç«¯å°ä¼™ä¼´åšåˆ°äº†ä¸€èµ·ï¼Œæå‡ºäº†è‡ªå·±å¯¹è¿™ä¸ª`SDK`çš„æœŸæœ›ã€‚

1. è¯¥æ¨¡å—æ˜¯ä¸ªäººæ¨¡å—ï¼Œéœ€è¦è€ƒè™‘éœ€è¦è¿›è¡Œé‰´æƒã€‚
2. ä½œä¸ºè°ƒç”¨æ–¹ï¼Œæˆ‘å¯ä¸æƒ³ç®¡ä½ æ¥å£æ˜¯`websocket`è¿˜æ˜¯`http`ï¼Œè¯·è‡ªå·±åœ¨`æ¥å£å±‚`å°è£…å¥½ã€‚
3. ä½ ä½œä¸ºä¸€ä¸ªè¯·æ±‚`lib`ï¼Œ`req`å’Œ`res`çš„`interceptor`è¿˜æ˜¯è¦æœ‰çš„å§ã€‚
4. å•Šå‘€ï¼Œæˆ‘ä»¬ç”¨`axios`éƒ½ä¹ æƒ¯äº†ï¼Œæ¥å£è¿”å›çš„æ˜¯ä¸€ä¸ªè¯·æ±‚çš„`Promise`ï¼Œè¿™æ¬¡ä¹Ÿæœ€åä¿æŒä¸€è‡´å§

åŠå…¬å®¤ä¸å¤§ï¼Œåç«¯çš„åŒå­¦ä¹Ÿå¬åˆ°äº†è®¨è®ºï¼Œé™„å’Œåˆ°:

1. è¿™è¾¹è¿˜éœ€è¦åŠ ä¸ªå¿ƒè·³ğŸ’“æœºåˆ¶å•Šï¼Œååˆ†é’Ÿå§ï¼Œæ²¡æœ‰å‘é€æ¶ˆæ¯ï¼Œæˆ‘è¿™è¾¹å°±æ–­å¼€å•¦ã€‚
2. è™½ç„¶ï¼Œå‰æœŸæˆ‘ä»¬åªåš`ä¿¡é“å¤ç”¨`å®ç°æ— åˆ·æ–°è¯·æ±‚ã€‚å¯åˆ«å¿˜å•¦ï¼ŒåæœŸæˆ‘ä»¬è¿˜æ˜¯è¦åšæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€çš„ã€‚
3. ä½ ä»¬èµ¶ç´§å§ï¼Œä¸‹ä¸‹å‘¨å¯å°±`deadline`äº†...

å˜šå˜ï¼Œä¸Šé©¬å¼€å·¥...

## é‰´æƒ
é¡¹ç›®å½“å‰çš„é‰´æƒæ˜¯ä¾èµ–ç”¨æˆ·ç™»å½•åï¼ŒæœåŠ¡ç«¯ä¸‹å‘ç”¨æˆ·`token`åˆ°`cookie`ä¸­ï¼Œæ­é…`header`ä¸­çš„æŸä¸ªå­—æ®µè¿›è¡Œä½¿ç”¨ã€‚

### ä¿¡é“å»ºç«‹æ—¶é‰´æƒ
ç”±äº`websocket`åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸å­˜åœ¨å’Œ`http`åè®®ä¸€æ ·çš„`cookie`ã€`request header`æœºåˆ¶ã€‚ä½†ä¿¡é“å»ºæ‰€ç”¨çš„è¯·æ±‚ï¼Œä»æ˜¯`http`è¯·æ±‚ï¼Œä½ ä¹Ÿä¸€å®šè§è¿‡è¿™ä¸ªè¯·æ±‚çš„æŠ¥æ–‡ã€‚

##### å‰ç«¯è§†è§’
![](/blog_assets/websocket_101_cookie.png)

##### æœåŠ¡ç«¯è§†è§’
```ts
const crypto = require('crypto');

// ç”Ÿæˆ websocket AcceptKey
function generateAcceptKey (websocketReqKey: string): string {
  const magic = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';
  return crypto.createHash('sha1')
  .update(websocketReqKey + magic)
  .digest('base64');
}
```

```ts

const headerParser = require('parse-headers')

const server = net.createServer(socket => {

  socket.on('data', async chunk => {
    const headers = headerParser(Buffer.from(chunk).toString())

    // æ£€æµ‹åˆ°æ˜¯ websocket å»ºç«‹ä¿¡é“çš„è¯·æ±‚
    if (headers['upgrade'] && headers['sec-websocket-key']) {
      const secWebSocketAccept = generateAcceptKey(headers['sec-websocket-key'])

      const cookies = header['cookie']

      // è¯·æ±‚ç”¨æˆ·æœåŠ¡èº«ä»½éªŒè¯
      const authorized = await checkAuth(cookie.authToken)

      if (authorized) {
        socket.write('HTTP/1.1 101 Web Socket Protocol Handshake\r\n' +
          'Upgrade: WebSocket\r\n' +
          'Connection: Upgrade\r\n' +
          'Sec-WebSocket-Accept: ' + secWebSocketAccept + '\r\n' +
          '\r\n');
      } else {
        socket.write('HTTP/1.1 403 Unauthorized\r\n' +
          '\r\n');
      }
    } else {
      socket.write('data')
    }
  })
}).listen(serverConfig.port, serverConfig.host);
```

ps: å¯¹åº”çš„æ¡†æ¶å®ç°ï¼Œå¯ä»¥å‚è€ƒ`ws - npm`æ¨¡å—çš„`verifyClient`çš„ç”¨æ³•,[ä¼ é€é—¨ğŸ‘‰](https://github.com/websockets/ws/blob/master/lib/websocket-server.js)

### æ•°æ®ä¼ è¾“æ—¶é‰´æƒ
æ•°æ®ä¼ è¾“æ—¶çš„é‰´æƒå»ºè®®åŸºäº`ä¿¡é“å»ºç«‹æ—¶é‰´æƒ`çš„æ–¹æ¡ˆï¼Œç”¨æˆ·ç¬¬ä¸€æ¬¡è®¤è¯åï¼Œå›ä¼ ç»™å®¢æˆ·ç«¯ä¸€ä¸ªç±»ä¼¼`token`çš„ä»¤ç‰Œï¼Œç”¨æˆ·åœ¨æ¯ä¸€æ¬¡ä½¿ç”¨`websocket`è¿›è¡Œæ•°æ®ä¼ è¾“æ—¶ï¼Œåˆ™éœ€è¦å›ä¼ è¿™ä¸ª`token`åˆ°æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ã€‚

ps: æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ï¼Œè¿™é‡Œå…¶å®ç›¸å½“äºå®ç°äº†ä¸ªæ‰‹åŠ¨`cookie`ã€‚


## å¿ƒè·³æœºåˆ¶
é¦–å…ˆè¯´æ˜ä¸€ç‚¹ï¼Œå¿ƒè·³æœºåˆ¶åœ¨`RFC`åè®®ä¸­æ²¡æœ‰åšè§„å®šï¼ŒåŸåˆ™ä¸Šä¸€ä¸ªè¿æ¥å¯ä»¥æ— é™åˆ¶æ—¶é—´å»è¿æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒæœåŠ¡å™¨çš„å†…å­˜ã€æ‰“å¼€æ–‡ä»¶æ•°é‡æ˜¯æœ‰é™çš„ï¼Œç‰¹åˆ«æ˜¯éœ€è¦åœ¨åŒä¸€ä¸ªæ—¶é—´æœåŠ¡æ›´å¤šç”¨æˆ·ï¼Œåˆ™éœ€è¦åŠæ—¶å‘ç°å¹¶æ–­å¼€é‚£äº›å·²ç»`ä¸åœ¨çº¿`ã€`ä¸æ´»è·ƒ`çš„è¿æ¥ã€‚

![](/blog_assets/websocket_keepalive.png)

ps: æ¯”å¦‚åšä¸€ä¸ªå†…éƒ¨ç³»ç»Ÿã€å…¬å¸å¤§å±ä»€ä¹ˆçš„ï¼Œè¿æ¥æ•°ä¸å¤šï¼Œå¯ä»¥ä¸éœ€è¦å¿ƒè·³æœºåˆ¶ä¹Ÿè¡Œã€‚

### åŸºç¡€çš„å¿ƒè·³
* ##### client
   ```js
   const ws = new WebSocket("ws://localhost:9527")

   // å¤§å®¶éƒ½å–œæ¬¢çš„ ping-pong
   ws.send('ping')

   // è·å–æ¥å£ç‰ˆæœ¬å·æ¥ä¿æ´»
   ws.send({
     jsonrpc: '2.0',
     method: 'version',
     data: null
   })
   ```
* ##### server
   ```js
   socket.on('data', data => {
      if (data === 'ping') {
        resetTimer() // é‡ç½®æ–­å¼€è®¡æ—¶å™¨
        socket.send('pong') // å‘é€å¿ƒè·³è¿”å›
      }
   })
    ```

### è°ƒçš®çš„nginx
é¡¹ç›®å¼€å‘å®Œçš„æ€»ç»“ä¼šä¸­ï¼ŒæŸ¥çœ‹æ—¥å¿—æ‰å‘ç°`webscoket`è¿æ¥ä»æœªå› ä¸ºè¾¾åˆ°è¿‡ä¸Šé™`10 min`æœªå‘é€å¿ƒè·³åŒ…è€Œæ–­å¼€ï¼Œå€’æ˜¯å‘ç°ä¸å°‘`60 s`æ–­å¼€çš„æ—¥å¿—ã€‚åç«¯åŒå­¦æç„¶å¤§æ‚Ÿ ---- `nginx`ã€‚

```nginx.conf
proxy_read_timeout 90ï¼›
```

ä¸ºäº†å¯ä»¥ç»Ÿä¸€åœ¨ä¸šåŠ¡ä»£ç ä¸­å¤„ç†å¿ƒè·³æœºåˆ¶ï¼Œè€Œä¸æ˜¯é€šè¿‡`nginx`æ¥å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†é’ˆå¯¹`websocket`è¯·æ±‚çš„`nginx`é…ç½®è°ƒæ•´äº†ä¸€ä¸‹
```nginx.conf
http {
    server {
        location /ws {
            root   html;
            index  index.html index.htm;
            proxy_pass xxx.xxx.xxx.xx:9527;
            proxy_http_version 1.1;
            proxy_connect_timeout 4s;
            proxy_read_timeout 700s;      # éœ€è¦æ¯”ä¸šåŠ¡å¿ƒè·³æ›´é•¿ä¸€ç‚¹
            proxy_send_timeout 12s;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }
}
```

### å¤©æœ‰ä¸æµ‹ä¹‹é£äº‘
ä½ ä¸€å®šçŸ¥é“å®¢æˆ·ç«¯å…³é—­`webcsocket`çš„`close`è¯­å¥
```js
// client
const ws = new WebSocket("ws://localhost:9527")
ws.close() // å…³é—­è¿æ¥

// server
const wss = new WebSocket.Server({ port: serverConfig.port });

wss.on('connection', function connection(ws) {
  ws.on('close', function (message) {
     console.log('websocket peer closed', message) // websocket peer closed 1005
  })
})
```
ä½†æ˜¯åœ¨å„ä¸ªç§æƒ…å†µä¸‹æ–­å¼€çš„`websocket`ï¼Œå¯¹ç«¯åˆæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸çŸ¥æ™“å‘¢ï¼Ÿ

| å…³é—­åœºæ™¯ | å‡ºç°æƒ…å†µ | å·±ç«¯æ˜¯å¦çŸ¥æ™“ |å¯¹ç«¯æ˜¯å¦çŸ¥æ™“ | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- |
| `ws.close()` | ç¨‹åºä»£ç ä¸»åŠ¨å…³é—­ | âœ… | âœ… |  |
| `åˆ·æ–°æµè§ˆå™¨` | ç¨‹åºä¸Šä¸‹æ–‡ä¸¢å¤± | âŒ | âœ… |  |
| `å…³é—­æµè§ˆå™¨1` | ç”¨æˆ·ç‚¹å‡»å…³é—­æµè§ˆå™¨ |âŒ | âœ… |  |
| `å…³é—­æµè§ˆå™¨2` | `kill å‘½ä»¤`æ€æ­»æµè§ˆå™¨è¿›ç¨‹ | âŒ | âœ… |  |
| `çªç„¶æ–­ç½‘` | `æ‰‹ç—’æ‹”ç½‘çº¿` `è¿›ç”µæ¢¯` | âŒ | âŒ | å¿ƒè·³æœºåˆ¶è¶…æ—¶ã€nginx è®¾ç½®è¶…æ—¶æ‰ä¼šè¢«å‘ç°ï¼Œè‹¥åœ¨è¶…å¸‚èŒƒå›´å†…é‡æ–°å‘é€äº†å¿ƒè·³ï¼Œåˆ™ç›¸å½“äºæ²¡æœ‰æ–­å¼€è¿‡ |

## è·¨åŸŸ ä¸ å®‰å…¨

### è·¨ç«™ç‚¹ WebSocket åŠ«æŒ

#### ä¿¡é“å»ºç«‹ä¾èµ–äºhttp
è‹¥æ˜¯é¡¹ç›®éªŒè¯èº«ä»½çš„tokenæ˜¯ä¿å­˜åœ¨cookieä¸­çš„ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“`websocket`çš„ä¿¡é“å»ºç«‹æ˜¯è¦é€šè¿‡`http`åè®®çš„`upgrade`å®Œæˆçš„ï¼Œé‚£ä¹ˆä¹Ÿå°±å­˜åœ¨æµè§ˆå™¨ä¸­çš„`CSRF`é—®é¢˜ã€‚

#### ä¸å­˜åœ¨è·¨åŸŸ
>  è·¨åŸŸèµ„æºå…±äº«ä¸é€‚åº”äº WebSocketï¼ŒWebSocket æ²¡æœ‰æ˜ç¡®è§„å®šè·¨åŸŸå¤„ç†çš„æ–¹æ³•ã€‚

ä¹Ÿå°±æ˜¯è¯´åœ¨æµè§ˆå™¨å±‚é¢ï¼Œä¸éœ€è¦è·¨åŸŸè®¿é—®çš„èµ„æºçš„æœåŠ¡å™¨è¿”å›`Access-Control-Allow-Origin`çš„`Response Header`ï¼Œæ•°æ®ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿”å›å¹¶ä¸”è§£æã€‚


### åŸæœ¬~~æ‰“ç®—~~çš„æ–¹æ¡ˆ
é’ˆå¯¹æ™®é€šçš„CSRFé—®é¢˜ï¼Œå…ˆå‰çš„åšæ³•æ˜¯åœ¨æ¥å£çš„`HTTP`è¯·æ±‚å¤´ä¸­ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„è¯·æ±‚ç­¾åè‡ªå®šä¹‰å¤´å­—æ®µã€‚è¿™æ ·åšå¯ä»¥åŸºæœ¬åšåˆ°å‘èµ·è¯·æ±‚çš„é¡µé¢ï¼Œæ˜¯å‡ºè‡ªæˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡ä»£ç ï¼Œè€Œå…¶ä»–ä¼ªé€ è¯·æ±‚çš„ä»£ç ï¼Œä¼šå› ä¸ºå¾—ä¸åˆ°ç­¾åå­—æ®µè€Œè¢«åç«¯æ‹¦æˆªæ‰ã€‚

#### ä¸æ”¯æŒä¿®æ”¹çš„è¯·æ±‚å¤´
ç›¸åŒçš„ï¼Œä¹Ÿæƒ³åœ¨websocket `ä¿¡é“å»ºç«‹`çš„è¯·æ±‚ä¸­ç…§è‘«èŠ¦ç”»ç“¢ã€‚

ä½†å®è·µä¸­å‘ç°ï¼Œä¸åŒäº`http`è¯·æ±‚ï¼Œ`websocket`è¯·æ±‚çš„`http Connect-upgrade`è¯·æ±‚æ˜¯æµè§ˆå™¨å†…éƒ¨å‘å‡ºçš„ï¼Œå¸‚é¢ä¸Šå¸¸è§çš„æµè§ˆå™¨éƒ½ä¸æ”¯æŒæˆ‘ä»¬å¯¹è¯·æ±‚å¤´è¿›è¡Œç¼–å†™ã€æ‹“å±•ã€åˆ é™¤ã€‚

æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¡Œä¸é€šã€‚

### å¯è¡Œçš„æ–¹æ¡ˆ
#### å®˜æ–¹å»ºè®®çš„æ–¹æ¡ˆ - check origin
æ¥äº†çœ‹çœ‹`rfc`æ˜¯å¦‚ä½•å»ºè®®æˆ‘ä»¬è§£å†³é—®é¢˜çš„å§

![](/blog_assets/websocket_rfc_origin_check.png)

å…¶ä¸­è“è‰²éƒ¨åˆ†å·²ç»æ”¯å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`ä¿¡é“å»ºç«‹`çš„`http`è¯·æ±‚çš„`origin`å­—æ®µè¿›è¡Œæ ¡éªŒï¼ŒæœåŠ¡ç«¯å¯ä»¥ç›´æ¥æ‹’ç»æ‰éæœ¬ç«™ç‚¹å‘èµ·çš„è¯·æ±‚ã€‚

#### è¡¥å……çš„æ–¹æ¡ˆ - token
è¿™æ¬¡çš„é¡¹ç›®è™½ç„¶åªæ˜¯web,ä½†æˆ‘ä»¬è¿›ä¸€æ­¥å¸è€ƒï¼Œè‹¥å‘èµ·è¯·æ±‚(é‡æ”¾è¯·æ±‚)çš„æ”»å‡»æ–¹ç¯å¢ƒå¹¶ä¸æ˜¯æµè§ˆå™¨å‘¢ï¼Ÿæ˜¯å®¢æˆ·ç«¯ï¼Œç”šè‡³æ˜¯è„šæœ¬æ‹¦æˆªè¯·æ±‚åçš„é‡æ”¾å‘¢ï¼Ÿ

è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç»™ä¿¡é“å»ºç«‹çš„httpè¯·æ±‚åŠ ä¸Šæ›´åŠ ä¸¥æ ¼çš„æŸç¼š - ä¸€æ¬¡æ€§è¿‡æœŸçš„Tokenã€‚

å¯è¡Œçš„å®é™…è¿‡ç¨‹å¯ä»¥æ˜¯:
* æœåŠ¡ç«¯å…ˆé€šè¿‡httpè¯·æ±‚ä¸‹å‘ä¸€ä¸ªTokenç»™å®¢æˆ·ç«¯ï¼Œå¯ä»¥æ˜¯æ”¾åˆ°cookieä¸­ï¼Œä½†å¿…é¡»æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„Tokenã€‚
* å®¢æˆ·ç«¯ä½¿ç”¨è¿™ä¸ªtokenæ¥å»ºç«‹ä¿¡é“ï¼Œå»ºç«‹æˆåŠŸåä¹‹åï¼ŒTokenä¹Ÿå°±éšå³åºŸå¼ƒã€‚
* å³ä½¿é‡åˆ°äº†é‡æ”¾ã€CSRFåŠ«æŒï¼Œä¹Ÿæ— éœ€å®³æ€•ä¸æ˜çš„æ¶æ„æ”»å‡»è€…èƒ½å¤Ÿè¿æ¥ä¸Šä½ çš„webscoketæœåŠ¡äº†ã€‚


## è¡¥å……
è¿™é‡Œè¡¥å……è¯´ä¸€ä¸‹`websocket`è¯·æ±‚å¤´ä¸­çš„ä¸€äº›å­—æ®µï¼Œç®—æ˜¯é¡¹ç›®å®‰å…¨å†³ç­–çš„ä¸€äº›è¾…åŠ©çŸ¥è¯†ã€‚


>  é»˜è®¤çš„å¤´å­—æ®µä»¬
* ##### request
  * `Sec-WebSocket-Key`: æ˜¯éšæœºçš„å­—ç¬¦ä¸²ï¼Œç”¨äºåç»­æ ¡éªŒã€‚
  * `Origin`: è¯·æ±‚æº
  * `Upgrade`: websocket
  * `Connection`: Upgrade

* ##### response
  * `Sec-WebSocket-Accept`: ç”¨åŒ¹é…å¯»æ‰¾å®¢æˆ·ç«¯è¿æ¥çš„å€¼ï¼Œè®¡ç®—å…¬å¼ä¸º`toBase64(sha1( Sec-WebSocket-Key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 ) )`
  è¿™é‡Œçš„`258EAFA5-E914-47DA-95CA-C5AB0DC85B11` ä¸ºé­”æœ¯å­—ç¬¦ä¸²ï¼Œä¸ºå¸¸é‡ã€‚
  > è‹¥è®¡ç®—ä¸æ­£ç¡®ï¼Œæˆ–è€…æ²¡æœ‰è¿”å›è¯¥å­—æ®µï¼Œåˆ™`websocket`è¿æ¥ä¸èƒ½å»ºç«‹æˆåŠŸ


## æ€»ç»“
`websocket`æ˜¯åŸºäº`tcp`ä¸Šçš„åº”ç”¨å±‚åè®®ï¼Œ`http`é‡åˆ°çš„é—®é¢˜`websocket`éƒ½ä¼šé‡åˆ°ï¼Œ`é‰´æƒ`ã€`ä¿æ´»`ã€`ç­¾å`ï¼Œè¿™äº›åœ¨`http`éƒ½æœ‰ç°æˆåŸºç¡€å¯ä»¥æ“ä½œï¼Œåœ¨`websocket`éƒ½éœ€è¦ä½¿ç”¨è€…è¿›è¡Œè®¾è®¡å®ç°ã€‚

æœ¬æ–‡è¯´å®Œäº†`websocket`ä¸åç«¯éƒ¨åˆ†ä¼ è¾“ä¿¡é“çš„é—®é¢˜ï¼Œä¸‹ä¸€ç¯‡åˆ™ä¼šç€é‡è®²è®²å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„`websocket`è¯·æ±‚`lib`ã€‚


## å‚è€ƒèµ„æ–™
[1] [æ·±å…¥ç†è§£è·¨ç«™ç‚¹ WebSocket åŠ«æŒæ¼æ´çš„åŸç†åŠé˜²èŒƒ](https://www.ibm.com/developerworks/cn/java/j-lo-websocket-cross-site/index.html)
[2] [How to Use Websockets in Golang: Best Tools and Step-by-Step Guide](https://yalantis.com/blog/how-to-build-websockets-in-go)
[3] [WebSocket çš„é‰´æƒæˆæƒæ–¹æ¡ˆ - Mo Ye](http://www.moye.me/2017/02/10/websocket-authentication-and-authorization/)
[4] [RFC - The WebSocket Protocol](https://tools.ietf.org/html/rfc6455)
