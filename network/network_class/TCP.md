# TCP 与 UDP
![](/blog_assets/TCP_UPD_COVER.png)
___
1️⃣ TCP (Transmission Control Protocol），UDP（User Datagram Protocol)
2️⃣ TCP提供并可开的通信传输，而UDP则常被用于让广播和细节控制交给应用的通信传输。
3️⃣ 传输层必须指出这个具体的程序，为了实现这个功能，使用`端口号`这样的一种识别码。

### TCP
1️⃣ TCP是面向连接的，可靠的流协议。
2️⃣ TCP可以提供“顺序控制”、“重发控制”、“流量空值”、“拥塞空值”。
3️⃣ 连接的概念：是指各种设备、线路、或网络中进行通信的连个应用程序为了相互传递消息而专有的、虚拟的网络线路，也叫做虚拟电路。在这个连接中，两个应用程序可以无障碍传输数据，而TCP则负责空值连接的建立、断开、保持等工作。
##### 4️⃣ 为什么是三次握手🤝和四次挥手👋？
   🔯 猜想握手次数越多看起来就越稳定，其实不然
   ♎️ 三次握手，正好发送端和接收端都完成了`“一发一收”`,`"基本"`确认了连接可通  
   ♏️ 断开连接的时候，请求方请求断开连接，接收端发送ACK表示收到了，并且追加一个信息表示“真的要断开吗？”，最后发送端还一个ACK给发送端就断开了连接
![](/blog_assets/tcp_handshakes.png)
<div style="text-align:center;">图摘自 图解 TCP/IP</div>

##### 5️⃣ 可靠的传输
每一次客户端发送的数据报文到达接收端的时候，接收端要马上返回一个'ACK'报文给发送端，然后发送端才会发送下一节的数据，若发送端没有接收到上一段报文的ACK(会有一个timeout机制)，则会认为这个报文由于各种原因没有发送成功，会马上进行重发。  

若接收端已经接受过则会进行丢弃。报文中设置了`序列号`和`确认应答号`，TCP便实现了可靠的传输。  
    
##### 7️⃣ 超时重发
时间会根据前面几次的情况去动态计算出来的，偏差越大，超时时间也就越大。重发的次数也有优化，某一个包若是达到一定的重发次数，就会放弃重发，进而终止连接。
##### 8️⃣ MSS
在三握手的阶段，TCP会计算出“最大消息长度“(Max Segment Size)，最理想的情况是和IP层不会被分片的大小一致。MSS也会被写入TCP首部信息中。
♐️ 通讯两头的机器TCP MSS大小不一，那么就会取较小值进行设置，定为后续真正每个数据包的大小。
##### 9️⃣ 滑动窗口
♉️ 窗口允许TCP同时发送多个请求，而不用等待前一个请求得到ACK确认，窗口的大小决定了无需等待机制可以发送数据的最大值。
♓️ 窗口的大小是确定的，而随着ACK的逐渐到来，窗口在随时时间不断移动，所以称之为滑动窗口。
🆔 滑动窗口模式下，某个报文的ACK若丢包，但是下一个(在一个window内的)报文的ACK正常，那么发送都都不会再进行重发。
☯️ 三次冗余ACK:若是某个报文发送的时候丢包，但接着的多个包发送正常，接收端返回的都会是同一个ACK，要求再次发送丢掉的那个包。发送端在累计接到三次相同的ACK之后，会把这个包强制重传一遍。  

##### 1️⃣0️⃣ 流控制
发送端根据接收端返回的报文中的某字段，确定接收端现在的接收能力，根据这个能力，发送端会限制数据的发送量。

##### 1️⃣1️⃣ 拥塞窗口
☣️ 慢启动，拥塞窗口的大小会随着开始设置的值1，每收到一次ACK的确认，就会进行指数型的增长
🆚 指数型增长后，超过了慢启动阈值，就会被改为限制到线性增长。
㊙️ 一旦触发超时重传，那么拥塞窗口的大小就会被重新设置为1，再进行慢启动
![](/blog_assets/tcp_slow_start.png)
⭕️ 窗口的大小与吞吐量
TCP通信的最大吞吐量由窗口搭大小W、和往返时间RTT决定的。
$$ T_m = \frac{W}{RTT} \quad $$
##### 1️⃣2️⃣ 延迟ACK应答
在滑动窗口模式下，没有必要对每一个数据包都进行ACK确认，可以进行一定的省略。

##### 1️⃣3️⃣ 捎带应答
在返回数据的时候捎带上一个数据的应答信息。


##### 头部解析
![](/blog_assets/TCP_header.png)

### UDP
1️⃣ UDP是不具有可靠性的数据报协议。细微的处理会交给上层去处理(也就是为应用层会给UDP做好各种限制)
2️⃣ 主要用于那些对高速传输和实时性有较高要求的通信或者广播📢协议。
* 包总量较少的通信(DNS,SNMP等)
* 视频音频等多媒体通信。
* 限定于LAN等特定多媒体通信
* 广播通信(广播、多播)

3️⃣ 比如一些语音或者视频通话中，就会使用UDP。而且，像RIP和DHCP登记于广播协议也要依赖于UDP。
4️⃣ 不提供复杂的控制机制，利用IP没想象无连接的通信服务。
##### 头部解析
![](/blog_assets/UDP_header.png)

### 传输层
1️⃣ 传输层也有类似于数据链路层的IP地址，我们称之为"端口号"，用于识别一台计算机上进行通信的不同应用程序。  
2️⃣ “协议号”不同，也可以用于区分两个不同的请求（区分UDP和TCP）  
3️⃣ “源IP” ➡️ “目标IP” ➡️ “协议号” ➡️ “源端口号” ➡️ “目标端口号” 这五项，只要有一项不一样，都可以讲一次请求区分为两次  

4️⃣ 常用的协议默认端口号：
| TCP端口号 | 服务名称 | 工作内容 |
| ------ | ------ | ------ |
| 1 | TCPmux| TCP Port Service Multiplexer |
| 21 | ftp| 文件传输 |
| 22 | ssh | ssh remote login protocol |
| 23 | telnet | telnet |
| 25 |  SMTP  |  |
| 53 | dpmin | DNS |
| 80 | http | world wide web http |
| 443 | https | http protocol over TLS/SSL |

| UDP端口号 | 服务名称 | 工作内容 |
| ------ | ------ | ------ |
| 520 | router | RIP |
| 67 | bootps | Bootstrap Protocol Server |


### 快速重传与快速恢复
##### TCP Reno 和 TCP Tahoe   

* 当 `rwnd` < `cwnd` : 是接收方的接收能力限制了发送方窗口的最大值。
* 当 `cwnd` < `rwnd` : 是网络的拥塞限制了发送方窗口的最大值。



### 校验和算法


___
### 参考文章
[图解TCP/IP]()  
[校验和原理的实现](https://www.baidu.com/link?url=qHgd6C6thVkS-0XxhhBped2XnU9cu2jBzIMKRvLqB_YPoyPazikrWfr4YZLuf5f2Ze_AHJzdkQi4ftuuDt08_pPGUs6GlRtxOluxTv_jmmO&wd=&eqid=c63b1da500019a6e000000065c3317ba)   
[紧急字段](https://bbs.csdn.net/topics/50269452)  
